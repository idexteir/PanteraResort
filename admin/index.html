<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<base href="../">
<title>Pantera Resort — Admin</title>
<link rel="icon" href="public/images/logo.jpg" />
<link rel="stylesheet" href="styles.css?v=2025-11-06" />
<style>
  table { width:100%; border-collapse:collapse; }
  th,td{padding:8px 10px; border-bottom:1px solid #eee; text-align:left;}
  th{background:#faf7f2; position:sticky; top:0;}
  .err{color:#b00020;font-weight:600;}
  .ok{color:#056839;font-weight:600;}
  .actions{display:flex;gap:8px;flex-wrap:wrap;}
  .edit-btn{background:#fff;border:1px solid var(--accent);}
  .edit-btn:hover{background:var(--accent);color:#fff;}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);
    display:none;align-items:center;justify-content:center;z-index:50;}
  .modal{width:min(720px,95vw);background:#fff;border-radius:16px;
    box-shadow:var(--shadow);padding:16px;}
  .modal-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;}
  .input,.select,.textarea{width:100%;padding:10px;border:1px solid var(--sand-400);
    border-radius:10px;}
  .textarea{min-height:80px;resize:vertical;}
</style>
</head>
<body>
<div class="container">
  <nav class="nav">
    <div class="brand">
      <img class="logo" src="public/images/logo.jpg" alt="logo">
      <div class="title">Pantera Resort — Admin</div>
    </div>
    <div class="links">
      <a href="../">Site</a>
      <a href="../menu/">Menu</a>
      <button id="login" class="btn ghost">Sign in with Google</button>
      <button id="logout" class="btn" style="display:none">Sign out</button>
    </div>
  </nav>

  <section class="card" id="guard">
    <p><strong>Staff only.</strong> Sign in with a whitelisted Google account.</p>
  </section>

  <section class="card" id="flash" style="display:none"></section>

  <section class="card" id="form-card" style="display:none">
    <h3>Add Item</h3>
    <form id="item-form">
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px">
        <label>Category<input name="category" required class="input"></label>
        <label>Price (SAR)<input name="price" required type="number" step="0.01" class="input"></label>
        <label>Name (EN)<input name="name_en" required class="input"></label>
        <label>Name (AR)<input name="name_ar" dir="rtl" class="input"></label>
        <label>Description (EN)<input name="desc_en" class="input"></label>
        <label>Description (AR)<input name="desc_ar" dir="rtl" class="input"></label>
        <label>Image URL<input name="image" class="input"></label>
        <label>Available<select name="available" class="select">
          <option value="true" selected>Yes</option><option value="false">No</option></select></label>
        <label>Display Order<input name="display_order" type="number" value="0" class="input"></label>
      </div>
      <button class="btn primary" type="submit" style="margin-top:12px">Add</button>
    </form>
  </section>

  <section class="card" id="list-card" style="display:none">
    <h3>Items</h3>
    <div id="items">Loading…</div>
  </section>

  <footer class="footer">© <span id="year"></span> Pantera Resort</footer>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="modal-backdrop">
  <div class="modal">
    <h3>Edit Item</h3>
    <form id="edit-form">
      <input type="hidden" name="id">
      <div class="modal-grid">
        <label>Category<input name="category" class="input" required></label>
        <label>Price (SAR)<input name="price" class="input" type="number" step="0.01" required></label>
        <label>Name (EN)<input name="name_en" class="input" required></label>
        <label>Name (AR)<input name="name_ar" class="input" dir="rtl"></label>
        <label>Description (EN)<textarea name="desc_en" class="textarea"></textarea></label>
        <label>Description (AR)<textarea name="desc_ar" class="textarea" dir="rtl"></textarea></label>
        <label>Image URL<input name="image" class="input"></label>
        <label>Available<select name="available" class="select">
          <option value="true">Yes</option><option value="false">No</option></select></label>
        <label>Display Order<input name="display_order" class="input" type="number" value="0"></label>
      </div>
      <div style="text-align:right;margin-top:12px">
        <button type="button" id="cancel-edit" class="btn">Cancel</button>
        <button type="submit" class="btn primary">Save</button>
      </div>
    </form>
  </div>
</div>

<script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script defer src="scripts/supa.js"></script>
<script>
document.addEventListener("DOMContentLoaded",()=>{
  const year=document.getElementById("year");year.textContent=new Date().getFullYear();
  const login=document.getElementById("login"),logout=document.getElementById("logout"),
        guard=document.getElementById("guard"),form=document.getElementById("form-card"),
        list=document.getElementById("list-card"),flash=document.getElementById("flash"),
        items=document.getElementById("items"),modal=document.getElementById("modal-backdrop"),
        editForm=document.getElementById("edit-form"),cancelEdit=document.getElementById("cancel-edit");
  const supa=window.getSupabase&&window.getSupabase();

  function showAuth(a){login.style.display=a?"none":"inline-flex";
    logout.style.display=a?"inline-flex":"none";
    guard.style.display=a?"none":"block";
    form.style.display=a?"block":"none";
    list.style.display=a?"block":"none";}
  function msg(t,c="ok"){flash.className="card "+(c==="ok"?"ok":"err");
    flash.textContent=t;flash.style.display="block";setTimeout(()=>flash.style.display="none",3000);}
  const openM=()=>modal.style.display="flex",closeM=()=>modal.style.display="none";

  async function isStaff(){const {data,error}=await supa.rpc("is_staff");return !error&&!!data;}

  async function load(){
    const {data,error}=await supa.from("menu_items").select("*")
      .order("category").order("display_order").order("name_en");
    if(error){items.innerHTML="<p class='err'>"+error.message+"</p>";return;}
    const g={};data.forEach(i=>(g[i.category]??=[]).push(i));
    items.innerHTML=Object.keys(g).map(c=>`
      <details open><summary><b>${c}</b></summary>
      <div style="overflow:auto"><table><thead>
      <tr><th>ID</th><th>Name</th><th>Price</th><th>Avail</th><th>Order</th><th>Image</th><th>Actions</th></tr>
      </thead><tbody>${g[c].map(it=>`
        <tr><td>${it.id}</td><td>${it.name_en}</td><td>${it.price.toFixed(2)}</td>
        <td>${it.available?"Yes":"No"}</td><td>${it.display_order??0}</td>
        <td>${it.image||""}</td>
        <td class="actions">
          <button class="btn edit-btn" data-edit="${it.id}">Edit</button>
          <button class="btn" data-del="${it.id}">Delete</button>
        </td></tr>`).join("")}</tbody></table></div></details>`).join("");

    // delete
    document.querySelectorAll("[data-del]").forEach(b=>b.onclick=async()=>{
      const id=+b.dataset.del;if(!confirm("Delete item #"+id+"?"))return;
      const {error}=await supa.from("menu_items").delete().eq("id",id);
      if(error)return msg(error.message,"err");msg("Deleted.");load();});
    // edit
    document.querySelectorAll("[data-edit]").forEach(b=>b.onclick=()=>{
      const id=+b.dataset.edit;const it=data.find(x=>x.id===id);
      if(!it)return;for(const f of ["id","category","name_en","name_ar",
        "desc_en","desc_ar","image"])editForm[f].value=it[f]||"";
      editForm.price.value=it.price||0;editForm.available.value=it.available?"true":"false";
      editForm.display_order.value=it.display_order||0;openM();});
  }

  document.getElementById("item-form").onsubmit=async e=>{
    e.preventDefault();const f=new FormData(e.target);
    const p={category:f.get("category"),price:+f.get("price"),
      name_en:f.get("name_en"),name_ar:f.get("name_ar")||null,
      desc_en:f.get("desc_en")||null,desc_ar:f.get("desc_ar")||null,
      image:f.get("image")||null,available:f.get("available")==="true",
      display_order:+f.get("display_order")||0};
    const {error}=await supa.from("menu_items").insert(p);
    if(error)return msg(error.message,"err");msg("Added.");e.target.reset();load();
  };
  editForm.onsubmit=async e=>{
    e.preventDefault();const f=new FormData(e.target);
    const id=+f.get("id"),p={category:f.get("category"),price:+f.get("price"),
      name_en:f.get("name_en"),name_ar:f.get("name_ar")||null,
      desc_en:f.get("desc_en")||null,desc_ar:f.get("desc_ar")||null,
      image:f.get("image")||null,available:f.get("available")==="true",
      display_order:+f.get("display_order")||0};
    const {error}=await supa.from("menu_items").update(p).eq("id",id);
    if(error)return msg(error.message,"err");msg("Updated.");closeM();load();
  };
  cancelEdit.onclick=closeM;modal.onclick=e=>{if(e.target===modal)closeM();};

  login.onclick=async()=>{await supa.auth.signOut({scope:"local"});
    await supa.auth.signInWithOAuth({provider:"google",
      options:{redirectTo:location.href,queryParams:{prompt:"select_account"}}});};
  logout.onclick=async()=>{await supa.auth.signOut({scope:"local"});location.reload();};

  supa.auth.onAuthStateChange(async(_,s)=>{
    if(!s?.user)return showAuth(false);
    if(!(await isStaff())){showAuth(false);msg("Unauthorized","err");
      return supa.auth.signOut({scope:"local"});}
    showAuth(true);load();});
  (async()=>{const {data:{session}}=await supa.auth.getSession();
    if(!session?.user)return showAuth(false);
    if(!(await isStaff())){showAuth(false);return supa.auth.signOut({scope:"local"});}
    showAuth(true);load();})();
});
</script>
</body>
</html>
